// ==========================================================================
// Project:   Ember Data
// Copyright: ©2011-2012 Tilde Inc. and contributors.
//            Portions ©2011 Living Social Inc. and contributors.
// License:   Licensed under MIT license (see license.js)
// ==========================================================================



// Last commit: 7656e63 (2013-05-28 17:06:31 -0700)


(function(){Ember.Adapter=Ember.Object.extend({find:function(){throw new Error("Ember.Adapter subclasses must implement find")},findQuery:function(){throw new Error("Ember.Adapter subclasses must implement findQuery")},findMany:function(){throw new Error("Ember.Adapter subclasses must implement findMany")},findAll:function(){throw new Error("Ember.Adapter subclasses must implement findAll")},load:function(r,e,t){r.load(e,t)},createRecord:function(){throw new Error("Ember.Adapter subclasses must implement createRecord")},saveRecord:function(){throw new Error("Ember.Adapter subclasses must implement saveRecord")},deleteRecord:function(){throw new Error("Ember.Adapter subclasses must implement deleteRecord")}})})(),function(){Ember.FixtureAdapter=Ember.Adapter.extend({find:function(r,e){var t=r.constructor.FIXTURES,i=Ember.A(t).find(function(r){return r.id===e});r.get("isLoaded")||setTimeout(function(){Ember.run(r,r.load,e,i)})},findMany:function(r,e,t){for(var i=r.FIXTURES,n=[],o=0,d=t.length;d>o;o++)n.push(i[o]);setTimeout(function(){Ember.run(e,e.load,r,n)})},findAll:function(r,e){var t=r.FIXTURES;setTimeout(function(){Ember.run(e,e.load,r,t)})},createRecord:function(r){var e=r.constructor,t=e.FIXTURES;return setTimeout(function(){Ember.run(function(){t.push(e.findFromCacheOrLoad(r.toJSON())),r.didCreateRecord()})}),r},saveRecord:function(r){var e=Ember.Deferred.create();return e.then(function(){r.didSaveRecord()}),setTimeout(function(){Ember.run(e,e.resolve,r)}),e},deleteRecord:function(r){var e=Ember.Deferred.create();return e.then(function(){r.didDeleteRecord()}),setTimeout(function(){Ember.run(e,e.resolve,r)}),e}})}(),function(){var r=Ember.get,e=Ember.set;Ember.RecordArray=Ember.ArrayProxy.extend(Ember.Evented,Ember.DeferredMixin,{isLoaded:!1,isLoading:Ember.computed.not("isLoaded"),load:function(r,t){e(this,"content",this.materializeData(r,t)),this.notifyLoaded()},loadForFindMany:function(t){var i=r(this,"_ids").map(function(r){return t.cachedRecordForId(r)});e(this,"content",Ember.A(i)),this.notifyLoaded()},notifyLoaded:function(){e(this,"isLoaded",!0),this.trigger("didLoad"),this.resolve(this)},materializeData:function(r,e){return Ember.A(e.map(function(e){return r.findFromCacheOrLoad(e)}))}})}(),function(){var r=Ember.get;Ember.FilteredRecordArray=Ember.RecordArray.extend({init:function(){if(!r(this,"modelClass"))throw new Error("FilteredRecordArrays must be created with a modelClass");if(!r(this,"filterFunction"))throw new Error("FilteredRecordArrays must be created with a filterFunction");if(!r(this,"filterProperties"))throw new Error("FilteredRecordArrays must be created with filterProperties");var e=r(this,"modelClass");e.registerRecordArray(this),this.registerObservers(),this.updateFilter()},updateFilter:function(){var e=this,t=[];r(this,"modelClass").forEachCachedRecord(function(r){e.filterFunction(r)&&t.push(r)}),this.set("content",Ember.A(t))},updateFilterForRecord:function(e){var t=r(this,"content");this.filterFunction(e)&&t.pushObject(e)},registerObservers:function(){var e=this;r(this,"modelClass").forEachCachedRecord(function(r){e.registerObserversOnRecord(r)})},registerObserversOnRecord:function(e){for(var t=this,i=r(this,"filterProperties"),n=0,o=r(i,"length");o>n;n++)e.addObserver(i[n],t,"updateFilterForRecord")}})}(),function(){function r(r,e){for(var t=0,i=r.length;i>t;t++)if(r[t]===e)return!0;return!1}function e(e,t){for(var i,n=0,o=t.length;o>n;n++)i=t[n],r(e,i)||e.push(i);return e}var t=Ember.get,i=Ember.set,n=Ember.meta;Ember.run.queues.push("data"),Ember.Model=Ember.Object.extend(Ember.Evented,Ember.DeferredMixin,{isLoaded:!0,isLoading:Ember.computed.not("isLoaded"),isNew:!0,isDeleted:!1,_dirtyAttributes:null,isDirty:Ember.computed(function(){for(var r,e,i,o,d,s,a,c=this.attributes,u=this._dirtyAttributes,h=0,f=c.length;f>h;h++)r=c[h],e=this.cacheFor(r),i=t(this,"data."+r),o=n(this).descs[r],d=o&&o.meta(),s=d.type,a=u&&-1!==u.indexOf(r),!a&&s&&s.isEqual&&(s.isEqual(i,e||i)||(u||(u=this._dirtyAttributes=Ember.A()),u.push(r)));return u&&0!==u.length}).property().volatile(),init:function(){t(this,"isNew")||this.resolve(this),this._super()},load:function(r,e){var t=Ember.merge({id:r},e);i(this,"data",t),i(this,"isLoaded",!0),i(this,"isNew",!1),this.trigger("didLoad"),this.resolve(this)},didDefineProperty:function(r,e,t){if(t instanceof Ember.Descriptor){var i=t.meta();i.isAttribute&&(r.attributes||(r.attributes=[]),r.attributes.push(e))}},toJSON:function(){return this.getProperties(this.attributes)},save:function(){var r=this.constructor.adapter;if(i(this,"isSaving",!0),t(this,"isNew"))return r.createRecord(this);if(t(this,"isDirty"))return r.saveRecord(this);var e=Ember.Deferred.create();return e.resolve(this),e},didCreateRecord:function(){i(this,"isNew",!1),this.load(this.get("id"),this.getProperties(this.attributes)),this.constructor.addToRecordArrays(this),this.trigger("didCreateRecord"),this.didSaveRecord()},didSaveRecord:function(){i(this,"isSaving",!1),this.trigger("didSaveRecord"),this._copyDirtyAttributesToData()},deleteRecord:function(){return this.constructor.adapter.deleteRecord(this)},didDeleteRecord:function(){this.constructor.removeFromRecordArrays(this),i(this,"isDeleted",!0),this.trigger("didDeleteRecord")},_copyDirtyAttributesToData:function(){if(this._dirtyAttributes){var r,e=this._dirtyAttributes,n=t(this,"data");n||(n={},i(this,"data",n));for(var o=0,d=e.length;d>o;o++)r=e[o],n[r]=this.cacheFor(r);this._dirtyAttributes=[]}}}),Ember.Model.reopenClass({adapter:Ember.Adapter.create(),find:function(r){return arguments.length?Ember.isArray(r)?this.findMany(r):"object"==typeof r?this.findQuery(r):this.findById(r):this.findAll()},findMany:function(r){var t=Ember.RecordArray.create({_ids:r});return this.recordArrays||(this.recordArrays=[]),this.recordArrays.push(t),this._currentBatchIds?(e(this._currentBatchIds,r),this._currentBatchRecordArrays.push(t)):(this._currentBatchIds=e([],r),this._currentBatchRecordArrays=[t]),Ember.run.scheduleOnce("data",this,this._executeBatch),t},findAll:function(){if(this._findAllRecordArray)return this._findAllRecordArray;var r=this._findAllRecordArray=Ember.RecordArray.create();return this.adapter.findAll(this,r),r},_currentBatchIds:null,_currentBatchRecordArrays:null,findById:function(e){var i=this.cachedRecordForId(e),n=t(this,"adapter");return t(i,"isLoaded")||(n.findMany?(this._currentBatchIds?r(this._currentBatchIds,e)||this._currentBatchIds.push(e):(this._currentBatchIds=[e],this._currentBatchRecordArrays=[]),Ember.run.scheduleOnce("data",this,this._executeBatch)):n.find(i,e)),i},_executeBatch:function(){var r,e=this._currentBatchIds,i=this._currentBatchRecordArrays,n=this;this._currentBatchIds=null,this._currentBatchRecordArrays=null,1===e.length?t(this,"adapter").find(this.cachedRecordForId(e[0]),e[0]):(r=Ember.RecordArray.create({_ids:e}),t(this,"adapter").findMany(this,r,e),r.then(function(){for(var r=0,e=i.length;e>r;r++)i[r].loadForFindMany(n)}))},findQuery:function(r){var e=Ember.RecordArray.create();return this.adapter.findQuery(this,e,r),e},cachedRecordForId:function(r){this.recordCache||(this.recordCache={});var e=this.sideloadedData&&this.sideloadedData[r],t=this.recordCache[r]||(e?this.create(e):this.create({isLoaded:!1}));return this.recordCache[r]||(this.recordCache[r]=t),t},addToRecordArrays:function(r){this._findAllRecordArray&&this._findAllRecordArray.pushObject(r),this.recordArrays&&this.recordArrays.forEach(function(e){e instanceof Ember.FilteredRecordArray?(e.registerObserversOnRecord(r),e.updateFilter()):e.pushObject(r)})},removeFromRecordArrays:function(r){this._findAllRecordArray&&this._findAllRecordArray.removeObject(r),this.recordArrays&&this.recordArrays.forEach(function(e){e.removeObject(r)})},findFromCacheOrLoad:function(r){var e=this.cachedRecordForId(r.id);return e.load(r.id,r),e},registerRecordArray:function(r){this.recordArrays||(this.recordArrays=[]),this.recordArrays.push(r)},unregisterRecordArray:function(r){this.recordArrays&&Ember.A(this.recordArrays).removeObject(r)},forEachCachedRecord:function(r){if(!this.recordCache)return Ember.A([]);var e=Object.keys(this.recordCache);e.map(function(r){return this.recordCache[parseInt(r,10)]},this).forEach(r)},load:function(r){this.sideloadedData||(this.sideloadedData={});for(var e=0,t=r.length;t>e;e++){var i=r[e];this.sideloadedData[i.id]=i}}})}(),function(){var r=Ember.get,e=Ember.set,t=Ember.meta;Ember.attr=function(i){return Ember.computed(function(n,o){var d=r(this,"data"),s=d&&r(d,n),a=t(this).proto===this;if(2===arguments.length){if(a)return d||(d={},e(this,"data",d),d[n]=o),o;var c;return c=i&&i.isEqual?i.isEqual(s,o):s===o,c?this._dirtyAttributes&&this._dirtyAttributes.removeObject(n):(this._dirtyAttributes||(this._dirtyAttributes=Ember.A()),this._dirtyAttributes.push(n)),o}return s&&"object"==typeof s&&(s=Ember.create(s)),s}).property("data").meta({isAttribute:!0,type:i})}}(),function(){var r=Ember.get;Ember.RESTAdapter=Ember.Adapter.extend({find:function(r,e){var t=this.buildURL(r.constructor,e),i=this;return this.ajax(t).then(function(t){i.didFind.call(i,r,e,t)})},didFind:function(e,t,i){var n=r(e.constructor,"rootKey"),o=n?i[n]:i;Ember.run(e,e.load,t,o)},findAll:function(r,e){var t=this.buildURL(r),i=this;return this.ajax(t).then(function(t){i.didFindAll.call(i,r,e,t)})},didFindAll:function(e,t,i){var n=r(e,"collectionKey"),o=n?i[n]:i;Ember.run(t,t.load,e,o)},findQuery:function(r,e,t){var i=this.buildURL(r),n=this;return this.ajax(i,t).then(function(i){n.didFindQuery.call(n,r,e,t,i)})},didFindQuery:function(e,t,i,n){var o=r(e,"collectionKey"),d=o?n[o]:n;Ember.run(t,t.load,e,d)},createRecord:function(r){var e=this.buildURL(r.constructor),t=this;return this.ajax(e,r.toJSON(),"POST").then(function(e){t.didCreateRecord.call(t,r,e)})},didCreateRecord:function(r,e){Ember.run(function(){r.load(e.id,e),r.didCreateRecord()})},saveRecord:function(e){var t=this.buildURL(e.constructor,r(e,"id")),i=this;return this.ajax(t,e.toJSON(),"PUT").then(function(r){i.didSaveRecord.call(i,e,r)})},didSaveRecord:function(r){Ember.run(r,r.didSaveRecord)},deleteRecord:function(e){var t=this.buildURL(e.constructor,r(e,"id")),i=this;return this.ajax(t,e.toJSON(),"DELETE").then(function(r){i.didDeleteRecord.call(i,e,r)})},didDeleteRecord:function(r){Ember.run(r,r.didDeleteRecord)},ajax:function(r,e,t){return this._ajax(r,e,t||"GET")},buildURL:function(e,t){var i=r(e,"url");if(!i)throw new Error("Ember.RESTAdapter requires a `url` property to be specified");return t?i+"/"+t+".json":i+".json"},_ajax:function(r,e,t){var i={url:r,type:t,dataType:"json"};return e&&"GET"!==t&&(i.contentType="application/json; charset=utf-8",i.data=JSON.stringify(e)),Ember.$.ajax(i)}})}(),"undefined"==typeof location||"localhost"!==location.hostname&&"127.0.0.1"!==location.hostname||console.warn("You are running a production build of Ember on localhost and won't receive detailed error messages. If you want full error messages please use the non-minified build provided on the Ember website.");